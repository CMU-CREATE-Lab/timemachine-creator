<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
</head>
<body>

<!--  Thumbnail -->

<img id="thumbnail" style="width:160px; height:120px">

<script>
window.api.readThumbnail("../patp10/00IMG_9946.JPG").assignToHTMLImageElement(document.getElementById('thumbnail'));
</script>

<hr>

<!-- EXIF times -->

<div>PATP10 Time: <span id="time"></span></div>
<div>PITT10x1 Time: <span id="time2"></span></div>

<script>
$('#time').text(window.api.exifTime("../patp10/00IMG_9946.JPG"));
$('#time2').text(window.api.exifTime("../pitt10x1/IMG_5000.JPG"));
</script>

<hr>

<!-- Save as -->

<button id="save_as">Save As...</button>

<script>
function saveAs() {
  var startDirectory = '';
  var saveDir = window.api.saveAsDialog('Save Time Machine Definition', startDirectory, '*.timemachinedefinition');
  if (saveDir == '') {
    alert('saveAs canceled');
  } else {
    alert('saveAs: ' + saveDir);
  }
}

$('#save_as').click(saveAs);
</script>

<hr>

<!-- Drag and drop files and folders -->

<div id="dropbox" style="background: #4f4; padding: 20px; display: table">Drop files and folders here</div>
<pre id="dropped"></pre>

<script>
function noopHandler(evt) {
  evt.stopPropagation();
  evt.preventDefault();
}
function dropHandler(evt) {
  evt.stopPropagation();
  evt.preventDefault();
  var droppedFiles = window.api.droppedFilesRecursive();
  window.api.readThumbnail(droppedFiles[0]).assignToHTMLImageElement(document.getElementById('thumbnail'));
  $('#dropped').text(droppedFiles.join('\n'));
}
var dropbox = document.getElementById("dropbox");
dropbox.addEventListener("dragenter", noopHandler, false);
dropbox.addEventListener("dragexit", noopHandler, false);
dropbox.addEventListener("dragover", noopHandler, false);
dropbox.addEventListener("drop", dropHandler, false);
</script>

<hr>

<!-- Test save as, write, and read -->

<button id="swr">Save, write, and read...</button>
<div id="swr_out"></div>
<script>
function saveWriteRead() {
  $('#swr_out').text('');
  var startDirectory = '';
  var saveDir = window.api.saveAsDialog('Save Time Machine Definition', startDirectory, '*.timemachinedefinition');
  if (saveDir == '') {
    alert('saveAs canceled');
  } else {
    if (!window.api.makeDirectory(saveDir)) {
      alert('Error creating directory ' + saveDir);
      return;
    }
    var definitionPath = saveDir + '/definition.timemachinedefinition';
    var writeData = {foo:3};
    if (!window.api.writeFile(definitionPath, JSON.stringify(writeData))) {
       alert('Error creating ' + definitionPath);
       return;
    }
    var readData = JSON.parse(window.api.readFile(definitionPath));
    $('#swr_out').text('Wrote ' + JSON.stringify(writeData) + ' to ' + definitionPath + ' and read back ' + JSON.stringify(readData));
  }
}

$('#swr').click(saveWriteRead);
</script>

<hr>

<!-- Test ruby subprocess -->

<button id="r10">Ruby count to 10</button>
<pre id="r10_out"></pre>

<script>

function r10() {
  if (!window.api.invokeRubySubprocess(['count_to_10.rb'], register_callback(r10_out))) {
    alert('Could not start ruby subprocess');
  }
  $('#r10_out').html('Starting count_to_10.rb\n');
}

function r10_out(out) {
  console.log("In r10_out, out=" + out);
  if (typeof out === 'number') {
    $('#r10_out').append("Process finished, exit code " + out + "\n");
  } else {
    $('#r10_out').append(out)
  }
}

$('#r10').click(r10);

callbacks = [];

function callback(id, arr) {
  console.log("callback " + id + " | " + arr);
  console.log("calling " + callbacks[id] + " with args " + arr);
  callbacks[id].apply(null, arr);
}

function register_callback(callback) {
  callbacks.push(callback);
  return callbacks.length - 1;
}

function initcallback() {
  window.api.callback.connect(callback);
}

$(initcallback);

</script>

</body>
</html>
