<!DOCTYPE html>
  <head>
    <title>GigaPan Time Machine Creator</title>
    <script src="assets/javascripts/jquery.min.js"></script>
    <script src="assets/javascripts/jquery-ui.min.js"></script>
    <link rel="stylesheet" type="text/css" href="assets/stylesheets/smoothness/jquery-ui.css"/>
    <style type="text/css">
      html {
        font-size: .8em;
        min-width: 640px;
        min-height: 480px;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        overflow:hidden;
        height:100%;
      }

      body {
        height: 100%;
      }

      a:hover{ text-decoration:none; }
      a { outline: none; }
      a.heading:hover{ text-decoration:underline !important; }

      #top_area {
        border-bottom-width:1px;
        border-bottom-style:solid;
        border-bottom-color:#000;
        border-left-width:1px;
        border-left-style:solid;
        border-left-color:#000;
        background-color: #fff;
      }

      #controls {
        border-right-width:1px;
        border-right-style:solid;
        border-right-color:#000;
      }

      .ui-tabs .ui-tabs-panel {
        padding: 1em 1.48em;
      }

      #zoomSlider .ui-widget-header {
        background: none;
      }

      #zoom {
        display:block;
        width:40px;
        height:212px;
        position:absolute;
        margin: 15px 0px 0px 20px;
        z-index:4;
      }

      a#zoomin {
        display:block;
        height:29px;
        width:28px;
        background-repeat:no-repeat;
        background-position:center;
        background-image:url(assets/images/zoom/zoom_in.png);
        position:absolute;
        top:0px;
        left:0px;
        z-index:4;
      }

      a#zoomin:hover{ background-image:url(assets/images/zoom/zoom_in_hover.png); }
      a#zoomin:active{ background-image:url(assets/images/zoom/zoom_in_down.png); }

      a#zoomout {
        display:block;
        height:29px;
        width:28px;
        background-repeat:no-repeat;
        background-position:center;
        background-image:url(assets/images/zoom/zoom_out.png);
        z-index:4;
        position:absolute;
        top:137px;
        left:0px;
        z-index:4;
      }

      a#zoomout:hover{ background-image:url(assets/images/zoom/zoom_out_hover.png); }
      a#zoomout:active{ background-image:url(assets/images/zoom/zoom_out_down.png); }

      #zoomSlider {
        width:8px;
        height:110px;
        background:#969DA1;
        border:1px solid #555555;
        position:absolute;
        top:27px;
        left:9px;
      }

      #zoomSlider .ui-slider-handle {
        width:28px;
        height:11px;
        background:url(assets/images/zoom/zoom_handle.png) no-repeat; overflow: hidden;
        border-style:none;
        border:none;
        left:-10px;
        z-index: 10;
      }

      #zoomSlider .ui-slider-handle:hover{background-image:url(assets/images/zoom/zoom_handle_hover.png);}
      #zoomSlider .ui-slider-handle:active{background-image:url(assets/images/zoom/zoom_handle_down.png);}
    </style>
    <script>
      var data = new Array();
      var scale = 64;
      var min = 0;
      var view = "thumbnails"
      var max;
      var selectedImages = new Array();
      var shiftAlreadyClicked = true;

      function getTime(pct) {
        var scroll = document.getElementById('scroll').scrollTop;
        return min + (scroll + $("#canvas").height() * pct) / scale;
      }

      function setTime(ctr) {
        document.getElementById('scroll').scrollTop = scale * (ctr - min) - $("#canvas").height() * 0.5;
      }

      function format2(n) {
        var ret = "" + n;
        return (ret.length == 1) ? "0" + ret : ret;
      }

      function refresh() {
      	if (data.length == 0) return;
        //console.log("refresh");
        var mintime = getTime(-1);
        var toptime = getTime(0);
        var maxtime = getTime(1);

        var ticktimes = [.1, .2, .5, 1, 2, 5, 10, 30, 60, 60 * 2, 60 * 5, 60 * 15, 60 * 30, 3600, 2 * 3600, 4 * 3600, 12 * 3600, 86400];
        // We want to display time axis labels no closer than every N pixels
        var tickPixels = 100;
        var ticktime = tickPixels / scale;
        for (var i = 0; i < ticktimes.length; i++) {
          if (ticktimes[i] >= ticktime) {
            ticktime = ticktimes[i];
            break;
          }
        }

        var canvas = document.getElementById('canvas');
        canvas.width = canvas.width;
        var context = canvas.getContext('2d');

        context.fillStyle = 'black';
        context.textBaseline = 'top';
        context.font = '9px sans-serif';

        var loading = false;

        for (var i = Math.floor(mintime / ticktime); i * ticktime <= maxtime; i++) {
          var time = i * ticktime;
          var y = scale * (time - toptime);
          var date = new Date(time * 1000);
          var label = date.getFullYear() + "-" + format2(date.getMonth() + 1) + "-" + format2(date.getDay()) + " " + format2(date.getHours()) + ":" + format2(date.getMinutes()) + ":" + format2(date.getSeconds()) + "." + Math.floor(date.getMilliseconds() / 100);
          context.fillText(label, 1, y);
        }

        var left_margin = 120;

        for (var c = 0; c < data.length; c++) {
          var col = data[c];
          for (var r = 0; r < col.length; r++) {
            var elt = col[r];
            if (elt.deleted) continue;
            if (elt.time >= mintime && elt.time <= maxtime) {
              var y = scale * (elt.time - toptime);
              var legend = elt.filename.replace(".time", "");
              if (elt.delta != undefined) legend += " " + elt.delta;
              if (view == "filenames") {
                context.fillText(legend, left_margin + c * 150, y);
              } else if (view == "thumbnails") {
                if (!elt.image) {
                  var thumnail;
                  if ((thumbnail = window.api.readThumbnail(elt.filename)) == null) {
                    context.fillRect(x, y, 160, 120);
                  } else {
                    var img = new Image;
                    thumbnail.assignToHTMLImageElement(img);
                    elt.image = img;
                  }
                }
                var x = left_margin + c * 150;
                elt.w = 120;
                elt.h = 160;
                elt.x = x;
                elt.y = y;
                context.save();
                context.transform(0, -1, 1, 0, (x + 80) - (y + 80), (x + 80) + (y + 80));
                if (!elt.image.complete) loading = true;
                if (elt.image.complete && elt.image.width > 0) {
                  //console.log("drawing image");
                  context.drawImage(elt.image, x, y);

                  if (jQuery.inArray(elt, selectedImages) >= 0) {
                    //console.log(selectedImages);
                    context.strokeStyle = '#CC0000';
                    context.lineWidth = 2;
                    context.strokeRect(elt.x, elt.y, 160, 120);
                  }


                } else {
                  //console.log("drawing box");
                  context.fillRect(x, y, 160, 120);
                }
                context.restore();
                context.fillText(legend, x, y + 161);
              } else {
                //console.log("drawing lines");
                context.fillRect(left_margin + c * 25, y, 25, 1);
              }
            }
          }
        }

        if (loading) setTimeout(refresh, 100);
      }

      HTMLCanvasElement.prototype.relMouseCoords = function(event) {
        var totalOffsetX = 0;
        var totalOffsetY = 0;
        var canvasX = 0;
        var canvasY = 0;
        var currentElement = this;

        do {
          totalOffsetX += currentElement.offsetLeft;
          totalOffsetY += currentElement.offsetTop;
        }
        while (currentElement = currentElement.offsetParent)

        canvasX = event.pageX - totalOffsetX;
        canvasY = event.pageY - totalOffsetY;

        // Fix for variable canvas width
        canvasX = Math.round(canvasX * (this.width / this.offsetWidth));
        canvasY = Math.round(canvasY * (this.height / this.offsetHeight));

        return {
          x: canvasX,
          y: canvasY
        }
      }

      function rescale() {
        min = 1e+100;
        max = -1e+100;

        for (var c = 0; c < data.length; c++) {
          var col = data[c];
          for (var r = 0; r < col.length; r++) {
            var elt = col[r];
            if (elt.deleted) continue;
            if (elt.time < min) min = elt.time;
            if (elt.time > max) max = elt.time;
          }
        }

        $("#world").height((max - min) * scale + 200); // Height of a thumnail (160) + height of filename text (8) + extra padding (32)
        $("#scroll").css({
          "height": ($("#controls").height() - $("#top_area").height() - 68) + "px"
        });

        $("#canvasdiv").css({
          "height": ($("#controls").outerHeight(true) - $("#top_area").outerHeight(true)) + "px"
        });

        $("#top_area").css({
          "width": ($("#canvasdiv").outerWidth(true) + 18) + "px"
        });

        $("#canvas").attr("width", $("#canvasdiv").width());
        $("#canvas").attr("height", $("#canvasdiv").height());

        var time_per_pixel = 1 / scale;
        var msg = "1 pixel = ";
        if (time_per_pixel < 1) {
          msg += Math.round(time_per_pixel * 1000) + " milliseconds";
        } else if (time_per_pixel < 60) {
          msg += time_per_pixel + " seconds";
        } else if (time_per_pixel < 3600) {
          msg += (Math.round(time_per_pixel / 60 * 100) / 100) + " minutes";
        } else {
          msg += (Math.round(time_per_pixel / 3600 * 100) / 100) + " hours";
        }
        $("#scale").html(msg);

        if (scale < 64) view = "lines"
        else view = "thumbnails"

      }

      function zoom(factor) {
        if (factor == .5) $("#zoomSlider").slider("value", ($("#zoomSlider").slider("option", "value") - $("#zoomSlider" ).slider("option", "step" )));
        else if (factor == 2) $("#zoomSlider").slider("value", ($("#zoomSlider").slider("option" , "value") + $("#zoomSlider" ).slider("option", "step" )));

        var time = getTime(0.5);

        if (scale * factor >= 2048 || scale * factor <= (1 / 128)) return;

        scale *= factor;

        rescale();
        setTime(time);
        refresh();

      }

      function keypress(e) {
        //var key = String.fromCharCode(e.keyCode);
        switch (e.which) {
          case 61: // equal/plus sign
          case 43:
            zoom(2);
            break;
          case 45: // minus sign
            zoom(0.5);
            break;
          case 127:
          case 46: // delete
            for (i = 0; i < selectedImages.length; i++) {
              // Mark as deleted, but do not actually delete. Useful for undo feature
              data[selectedImages[i].col][selectedImages[i].row].deleted = true;
            }
            selectedImages.splice(0, selectedImages.length);
            rescale();
            refresh();
            break;
          default:
            console.log("key " + e.which);
        }
      }

      function computeDeltas() {
        // Deltas in first column are from previous image
        var col = data[0];
        for (var r = 1; r < col.length; r++) {
          col[r].delta = Math.round((col[r].time - col[r - 1].time) * 100) / 100;
        }
        // Deltas in other colums are relative to first column
        for (var c = 1; c < data.length; c++) {
          var col = data[c];
          var reference = data[0];
          var ref_r = 0;
          for (var r = 0; r < col.length; r++) {
            while (ref_r < reference.length && reference[ref_r].time < col[r].time) ref_r++;
            var reftime;
            if (ref_r == 0) reftime = reference[ref_r].time;
            else if (ref_r == reference.length) reftime = reference[ref_r - 1].time;
            else if (Math.abs(col[r].time - reference[ref_r - 1].time) < Math.abs(col[r].time - reference[ref_r].time)) {
              reftime = reference[ref_r - 1].time;
            } else {
              reftime = reference[ref_r].time;
            }
            col[r].delta = Math.round((col[r].time - reftime) * 100) / 100;
          }
        }
      }

      function inBounds(elm, mx, my) {
        // Make sure mouse x,y fall in the area between the
        // shape's x and (x + height) and its y and (y + height)
        return (elm.x <= mx) && (elm.x + elm.w >= mx) && (elm.y <= my) && (elm.y + elm.h >= my);
      }

      function init() {
        console.log("loaded");
        //$.ajax({
        //  url: "pit10.json",
        //  dataType: "json",
        //  success: function(d) {
        //    console.log("json success");
        //    data = d;
        //    computeDeltas();
            rescale();
            refresh();
            $("#numFrames").text(data.length + " Frames")
        //  }
        //});

        $("body").keypress(keypress);

        $("#zoomSlider").slider({
          orientation: "vertical",
          range: "min",
          min: 0,
          max: 16,
          value: 12,
          slide: function(event, ui) {
            //console.log(ui.value);
            if ($(this).slider("option", "value") > ui.value) {
              zoom(.5);
              //console.log($("#zoomSlider").slider("option", "value"));
              $("#zoomSlider").slider("option", "value",($("#zoomSlider").slider("option", "value")*0.5));
            } else {
              zoom(2);
              $("#zoomSlider").slider("option", "value",($("#zoomSlider").slider("option", "value")*2));
            }
          },
          stop: function(event, ui) {
             var values = [0.015625,0.03125,0.0625,0.125,0.25,0.5,1,2,4,8,16,32,64,128,256,512,1024];
             scale = values[$("#zoomSlider").slider("option", "value")];
             rescale(1);
             refresh();
          }
        });

        $("#zoomSlider .ui-slider-handle").attr("title", "Drag to zoom");

        setupSliderHandlers();

        var mouseSelection = false;
        var originalPos;
        var originalCanvasPos;

        $('#world').mousedown(function(e) {

          mouseSelection = true;
          originalPos = [e.pageX, e.pageY];
          originalCanvasPos = canvas.relMouseCoords(e);

          var coords = originalCanvasPos;
          var itemInBounds = false;

          for (i = 0; i < data[0].length; i++) {
          	if (data[0][i].deleted) continue;
            if (inBounds(data[0][i], coords.x, coords.y)) {
              if (!(e.ctrlKey || e.metaKey) && !e.shiftKey) selectedImages.length = 0;

              if (e.shiftKey) {

                if (selectedImages.length == 0) {
                  for (j = 0; j <= i; j++) {
                    selectedImages.push(data[0][j]);
                  }
                } else {

                  var oneClicked = data[0][i];
                  var lastOneClicked = selectedImages[selectedImages.length - 1];
                  var lastOneClickedIndex = $.inArray(lastOneClicked, data[0]);
                  var firstOneClicked = selectedImages[0];
                  var firstOneClickedIndex = $.inArray(firstOneClicked, data[0]);

                  if (shiftAlreadyClicked && (oneClicked.filename == lastOneClicked.filename)) break;

                  selectedImages.length = 0;
                  var startIndex = shiftAlreadyClicked ? firstOneClickedIndex : lastOneClickedIndex;
                  if (i > lastOneClickedIndex) {
                    for (j = startIndex; j <= i; j++) {
                      selectedImages.push(data[0][j]);
                    }
                  } else {
                    for (j = startIndex; j >= i; j--) {
                      selectedImages.push(data[0][j]);
                    }
                  }
                }
                shiftAlreadyClicked = true;
              } else {
                shiftAlreadyClicked = false;
                if ($.inArray(data[0][i], selectedImages) < 0) selectedImages.push(data[0][i]);
                else selectedImages.splice($.inArray(data[0][i], selectedImages), 1);
              }
              itemInBounds = true;
              break;
            }
          }

          if (!itemInBounds) {
            if (!(e.ctrlKey || e.metaKey) && !e.shiftKey) selectedImages.length = 0;
          }
          refresh();

        });

        $('body').mousemove(function(e) {
          if (mouseSelection) {

            if ($('#selection_area').length == 0) {
              var div = $('<div id="selection_area" style="position: absolute; border-style:dotted; border-width:2px; border-color: #666d68; z-index: 400"></div>');
              div.css({
                'left': e.pageX,
                'top': e.pageY,
                'width': 0,
                'height': 0
              });
              $('body').append(div);
            }

            var x1 = originalPos[0], y1 = originalPos[1], x2 = event.pageX, y2 = event.pageY;
            var coords = canvas.relMouseCoords(e);
            var origCanvasX = originalCanvasPos.x, origCanvasY = originalCanvasPos.y;
            var width = (x2 - x1), height = (y2 - y1);

            if (x1 > x2) {
              var tmp = x2;
              x2 = x1;
              x1 = tmp;
              width = (x2 - x1);
              origCanvasX -= width;
              coords.x += width;
            }

            if (y1 > y2) {
              var tmp = y2;
              y2 = y1;
              y1 = tmp;
              height = (y2 - y1);
              origCanvasY -= height;
              coords.y += height;
            }

            $('#selection_area').css({
              'left': x1,
              'top': y1,
              'width': width,
              'height': height
            });

            //!(r2.left > r1.right || r2.right < r1.left || r2.top > r1.bottom || r2.bottom < r1.top);
            for (i = 0; i < data[0].length; i++) {
            	if (data[0][i].deleted) continue;
              // Determine whether the selection rectangle intersects one of our data objects (also a rectangle)
              if (!(origCanvasX > data[0][i].x + data[0][i].w || coords.x < data[0][i].x || origCanvasY > data[0][i].y + data[0][i].h || coords.y < data[0][i].y)) {
                if ($.inArray(data[0][i], selectedImages) < 0) {
                  selectedImages.push(data[0][i]);
                  refresh();
                  break;
                }
              } else {
              	var idx = $.inArray(data[0][i], selectedImages);
                if (idx >= 0) {
                  selectedImages.splice(idx, 1);
                  refresh();
                }
              }
            }

          }
        });

        $(document).mouseup(function(e) {
          $('#selection_area').remove();
          mouseSelection = false;
        });

      }

      $(init);
    </script>
    <script>
      function setupSliderHandlers() {
        $(".ui-slider-handle").bind("mouseover mouseup", function() {
          this.style.cursor = 'url("assets/stylesheets/cursors/openhand.png") 10 10, move';
        });

        $(".ui-slider").bind({
          slide: function() {
            this.style.cursor = 'url("assets/stylesheets/cursors/closehand.png") 10 10, move';
            $(".ui-slider-handle").bind("mousemove", function() {
              this.style.cursor = 'url("assets/stylesheets/cursors/closehand.png") 10 10, move';
            });
          }, slidestop: function() {
            $(".ui-slider-handle").bind("mousemove", function() {
              this.style.cursor = 'url("assets/stylesheets/cursors/openhand.png") 10 10, move';
            });
          }, mouseover: function() {
            this.style.cursor = "pointer";
          }
        });
      }

      $(function() {
        $("#tabs").tabs();
      });

      // Prevent browser from loading dropped files as if it is a new page
      document.addEventListener("dragover", function(e) {
        e = e || event;
        e.preventDefault();
      }, false);
      document.addEventListener("drop", function(e) {
        e = e || event;
        e.preventDefault();
      }, false);
    </script>
  </head>

  <body style="margin:0" onresize="rescale(); refresh()">
    <div id="tabs" style="height: 100%;">
      <ul>
        <li>
          <a href="#tabs-1">Organize Images</a>
        </li>
        <li>
          <a href="#tabs-2">Render and Export</a>
        </li>
      </ul>
      <div id="tabs-1">
        <div id="zoom" style="position:aboslute; margin-left: 200px; margin-top: 140px">
          <div id="scale" style="position:aboslute; margin-left: -15px; margin-top: -25px; width: 200px; font-size: 12px;"></div>
          <a href="javascript:void(0);" title="Zoom in" id="zoomin" onclick="zoomIn()"></a>
          <a href="javascript:void(0);" title="Zoom out" id="zoomout" onclick="zoomOut()"></a>
          <div id="zoomSlider" title="Click to zoom"></div>
        </div>
        <div id="scroll" style="margin-top: 108px; width:100%; height: 100%; background:#eee; overflow-y:auto; margin-left: 20px;" onscroll="refresh()">
          <div id="canvasdiv" style="background:#eee; position:absolute; height:100%; left:200px; right:20px; margin-left: 160px;">
            <canvas id="canvas" style="background:#eee;height:100%"></canvas>
          </div>
          <!-- note: world is on top of canvas to capture mouse scrollwheel events,
          but is transparent to not block canvas -->
          <div id="world" style="height:10000px; width:100%; opacity:0;"></div>
        </div>
        <div id="top_area" style="position:absolute; height:100px; top:60px; left:200px;width:100%;">
          <!-- Drag and drop files and folders -->
          <div id="dropbox" style="border-style:dotted; border-width: 4px; background: #f5f5f5; padding: 20px; display: table; width: 50%; margin: 0px auto; text-align: center; height: 80px">
            Drop images or directories here
          </div>
          <script>
            function zoomIn() {
              zoom(2);
            }

            function zoomOut() {
              zoom(.5)
            }

            function noopHandler(evt) {
              $("#dropbox").css({
                "background": "Gainsboro"
              })
              evt.stopPropagation();
              evt.preventDefault();
            }

            function removeDropHighlight(evt) {
              $("#dropbox").css({
                "background": "#f5f5f5"
              })
            }

            function dropHandler(evt) {
              $("#dropbox").css({
                "background": "#f5f5f5"
              })
              evt.stopPropagation();
              evt.preventDefault();
              var droppedFiles = window.api.droppedFilesRecursive();
              //$('#dropped').text(droppedFiles.join('\n'));
              //console.log(droppedFiles);
              var col = new Array();
              for (i = 0; i < droppedFiles.length; i++) {
                //var thumbnail;
                if (droppedFiles[i].match(/\.jpg|.png$/i) == null) continue;
                //if ((thumbnail = window.api.readThumbnail(droppedFiles[i])) == null) continue;
                //var img = new Image;
                var h = {};
                //thumbnail.assignToHTMLImageElement(img);

                h['filename'] = droppedFiles[i]; //droppedFiles[i].replace(/\\/g,'/').replace( /.*\//, '' );
                //h['image'] = img;
                h['time'] = window.api.exifTime(droppedFiles[i]);
                h['row'] = i;
                h['col'] = 0; // TODO: single camera support only at this time
                h['deleted'] = false;
                //console.log(h);
                col.push(h);
              }

              data = new Array();
              data.push(col);
              $("#numFrames").text(data[0].length + " Frames")
              //console.log(data);
              //computeDeltas();

              if (data[0].length > 0) {
                rescale();
                refresh();
              }
            }
            var dropbox = document.getElementById("dropbox");
            dropbox.addEventListener("dragenter", noopHandler, false);
            dropbox.addEventListener("dragexit", noopHandler, false);
            dropbox.addEventListener("dragover", noopHandler, false);
            dropbox.addEventListener("drop", dropHandler, false);
            dropbox.addEventListener("dragleave", removeDropHighlight, false);
          </script>
        </div>
        <div id="controls" style="background:#fff; position:absolute; height:100%; top:60px; left:0px; width:200px">
          <p style="padding: 0px 0px 0px 10px">
            Format:
            <button type="button" disabled="disabled">
              Change
            </button>
            <br/>
            <br/>
            Single, fixed camera capture.
          </p>
          <p id="numFrames" style="padding: 0px 0px 0px 10px;bottom: 80px;position: absolute;">
          </p>
        </div>
      </div>
      <div id="tabs-2">
        <p>
          Nothing to see here, move along.
        </p>
      </div>
    </div>
  </body>
</html>
